stages:
  - build
  - update

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

# ---------------------------
# JOB 1 : BUILD + PUSH vers Harbor
# ---------------------------
build_and_push:
  stage: build
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  script:
    - echo "$HARBOR_PASSWORD" | docker login -u "$HARBOR_USERNAME" --password-stdin $HARBOR_URL
    - docker build -t $IMAGE_NAME:$TAG .
    - docker push $IMAGE_NAME:$TAG
    - docker tag $IMAGE_NAME:$TAG $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always

update_changelog:
  stage: update
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - apk add --no-cache git curl jq bash
    - |
      # ‚¨áÔ∏è Install git-chglog
      GIT_CHGLOG_VERSION=0.15.1
      curl -sSL "https://github.com/git-chglog/git-chglog/releases/download/v${GIT_CHGLOG_VERSION}/git-chglog_${GIT_CHGLOG_VERSION}_linux_amd64.tar.gz" -o git-chglog.tar.gz
      tar -xzf git-chglog.tar.gz
      mv git-chglog /usr/local/bin/
  script:
    - echo "üì¶ Tag actuel est le $CI_COMMIT_TAG"
    - PREVIOUS_TAG=$(git tag --sort=creatordate | grep -v "$CI_COMMIT_TAG" | tail -n 1)
    - echo "üïì Tag pr√©c√©dent est le $PREVIOUS_TAG"

    - |
      if [ -z "$PREVIOUS_TAG" ]; then
        echo "‚ùå Aucun tag pr√©c√©dent trouv√©. Abandon."
        exit 1
      fi

    - echo "üìù G√©n√©ration du changelog entre $PREVIOUS_TAG -> $CI_COMMIT_TAG"
    - git-chglog "$CI_COMMIT_TAG" --next-tag "$CI_COMMIT_TAG" > temp_changelog.md

    - if [ -f CHANGELOG.md ]; then cp CHANGELOG.md OLD_CHANGELOG.md; else touch OLD_CHANGELOG.md; fi
    - cat temp_changelog.md OLD_CHANGELOG.md > CHANGELOG.md

    - git config --global user.email "ci@martinbranda.com"
    - git config --global user.name "GitLab CI"
    - git checkout $CI_COMMIT_REF_NAME
    - git add CHANGELOG.md
    - git commit -m "üìù MAJ changelog automatique pour $CI_COMMIT_TAG"
    - git push origin $CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
