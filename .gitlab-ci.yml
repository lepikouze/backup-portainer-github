stages:
  - changelog

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

generate_changelog:
  image: docker:latest
  stage: changelog
  services:
    - docker:dind
  before_script:
    - apk add --no-cache git curl
    - curl -sSL https://github.com/git-chglog/git-chglog/releases/download/v0.15.1/git-chglog_0.15.1_linux_amd64.tar.gz | tar -xz -C /usr/local/bin git-chglog
  script:
    - export VERSION=$(git describe --tags --abbrev=0)
    - git-chglog "$VERSION" > CHANGELOG.md
    - git config user.email "ci@example.com"
    - git config user.name "CI Bot"
    - git add CHANGELOG.md
    - git commit -m "docs(changelog)' update for $VERSION"
    - git push https://${GITLAB_DEPLOY_TOKEN}@gitlab.home.martinbranda.com/louis/backup-portainer-github.git HEAD:master
  when: manual
  allow_failure: false
