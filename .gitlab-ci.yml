stages:
  - update

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

update_changelog:
  stage: update
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - apk add --no-cache git curl jq bash
  script:
    - echo "üì¶ Tag actuel est le $CI_COMMIT_TAG"
    - PREVIOUS_TAG=$(git tag --sort=creatordate | grep -v "$CI_COMMIT_TAG" | tail -n 1)
    - echo "üïì Tag pr√©c√©dent est le $PREVIOUS_TAG"

    # G√©n√©ration changelog via container (pas besoin d'installer en local)
    - docker run --rm -v "$PWD":/app -w /app ghcr.io/git-chglog/git-chglog "$PREVIOUS_TAG..$CI_COMMIT_TAG" > temp_changelog.md

    # Concat avec ancien changelog si pr√©sent
    - if [ -f CHANGELOG.md ]; then cp CHANGELOG.md OLD_CHANGELOG.md; else touch OLD_CHANGELOG.md; fi
    - cat temp_changelog.md OLD_CHANGELOG.md > CHANGELOG.md

    # Config Git
    - git config --global user.email "ci@martinbranda.com"
    - git config --global user.name "GitLab CI"

    # Remote avec token
    - echo "Remote URL utilis√© https://$GITLAB_DEPLOY_USER:<masked>@gitlab.home.martinbranda.com/louis/backup-portainer-github.git"
    - git remote set-url origin https://$GITLAB_DEPLOY_USER:$GITLAB_DEPLOY_TOKEN@gitlab.home.martinbranda.com/louis/backup-portainer-github.git

    # Commit et push si changement
    - git checkout $CI_COMMIT_REF_NAME
    - git add CHANGELOG.md
    - git diff --cached --quiet || (git commit -m "üìù MAJ changelog automatique pour $CI_COMMIT_TAG" && git push origin $CI_COMMIT_REF_NAME)
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
