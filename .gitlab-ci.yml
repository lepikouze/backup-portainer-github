stages:
  - update

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

update_changelog:
  stage: update
  image: alpine:latest
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - apk add --no-cache git curl jq bash tar
    - |
      echo "‚¨áÔ∏è Installation git-chglog (v0.15.1)"
      GIT_CHGLOG_VERSION="0.15.1"
      curl -sSL "https://github.com/git-chglog/git-chglog/releases/download/v${GIT_CHGLOG_VERSION}/git-chglog_${GIT_CHGLOG_VERSION}_linux_amd64.tar.gz" -o git-chglog.tar.gz
      tar -xzf git-chglog.tar.gz
      chmod +x git-chglog
      mv git-chglog /usr/local/bin/git-chglog
  script:
    - git config --global user.email "ci@martinbranda.com"
    - git config --global user.name "GitLab CI"
    - echo "üì¶ Tag actuel est le $CI_COMMIT_TAG"
    - PREVIOUS_TAG=$(git tag --sort=creatordate | grep -v "$CI_COMMIT_TAG" | tail -n 1)
    - echo "üïì Tag pr√©c√©dent est le $PREVIOUS_TAG"
    - echo "üìù G√©n√©ration du changelog entre $PREVIOUS_TAG -> $CI_COMMIT_TAG"
    - git-chglog "$PREVIOUS_TAG..$CI_COMMIT_TAG" > temp_changelog.md
    - if [ -f CHANGELOG.md ]; then cp CHANGELOG.md OLD_CHANGELOG.md; else touch OLD_CHANGELOG.md; fi
    - cat temp_changelog.md OLD_CHANGELOG.md > CHANGELOG.md
    - git remote set-url origin https://$GITLAB_DEPLOY_USER:$GITLAB_DEPLOY_TOKEN@gitlab.home.martinbranda.com/louis/backup-portainer-github.git
    - git checkout $CI_COMMIT_REF_NAME
    - git add CHANGELOG.md
    - git commit -m "üìù MAJ changelog automatique pour $CI_COMMIT_TAG" || echo "Pas de modifications"
    - git push origin $CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always

