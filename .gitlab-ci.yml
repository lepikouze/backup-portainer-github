stages:
  - update

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

update_changelog:
  stage: update
  image: docker:latest
  services:
    - name: docker:dind
      alias: docker
  before_script:
    - apk add --no-cache git curl jq bash
    - |
      # ‚¨áÔ∏è Install git-chglog
      GIT_CHGLOG_VERSION=0.15.1
      curl -sSL "https://github.com/git-chglog/git-chglog/releases/download/v${GIT_CHGLOG_VERSION}/git-chglog_${GIT_CHGLOG_VERSION}_linux_amd64.tar.gz" -o git-chglog.tar.gz
      tar -xzf git-chglog.tar.gz
      mv git-chglog /usr/local/bin/
  script:
    - echo "üì¶ Tag actuel est le $CI_COMMIT_TAG"
    - PREVIOUS_TAG=$(git tag --sort=creatordate | grep -v "$CI_COMMIT_TAG" | tail -n 1)
    - echo "üïì Tag pr√©c√©dent est le $PREVIOUS_TAG"

    - |
      if [ -z "$PREVIOUS_TAG" ]; then
        echo "‚ùå Aucun tag pr√©c√©dent trouv√©. Abandon."
        exit 1
      fi

    - echo "üìù G√©n√©ration du changelog entre $PREVIOUS_TAG -> $CI_COMMIT_TAG"
    - git-chglog "$PREVIOUS_TAG..$CI_COMMIT_TAG" > temp_changelog.md

    - if [ -f CHANGELOG.md ]; then cp CHANGELOG.md OLD_CHANGELOG.md; else touch OLD_CHANGELOG.md; fi
    - cat temp_changelog.md OLD_CHANGELOG.md > CHANGELOG.md

    - echo "Remote URL utilis√© https://$GITLAB_DEPLOY_USER:<masked>@gitlab.home.martinbranda.com/louis/backup-portainer-github.git"
    - git remote set-url origin https://$GITLAB_DEPLOY_USER:$GITLAB_DEPLOY_TOKEN@gitlab.home.martinbranda.com/louis/backup-portainer-github.git
    - git remote -v
    - git config --global --list
    - git push origin $CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_TAG'
      when: always
