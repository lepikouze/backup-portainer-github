stages:
  - sync

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  TAG: "$CI_COMMIT_TAG"
  IMAGE_NAME: "$HARBOR_URL/backup-portainer-github/backup-portainer-github"

create_github_release:
  stage: sync
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq git
  script:
    - git fetch --unshallow || true
    - git fetch --tags

    - LAST_TAG="$CI_COMMIT_TAG"
    - echo "üìù Lecture du changelog pour $LAST_TAG"

    - |
      if [ ! -f CHANGELOG.md ]; then
        echo "‚ùå Fichier CHANGELOG.md introuvable"
        exit 1
      fi

      # Extraire le bloc de changelog entre deux balises ## vX.X.X
      CHANGELOG_BODY=$(awk "/^## $LAST_TAG/{flag=1;next}/^## /{flag=0}flag" CHANGELOG.md)

      if [ -z "$CHANGELOG_BODY" ]; then
        echo "‚ùå Aucun changelog trouv√© pour $LAST_TAG"
        exit 1
      fi

      echo "‚úÖ Contenu extrait :"
      echo "$CHANGELOG_BODY"

    - |
      curl -s -X POST https://api.github.com/repos/$GITHUB_USERNAME/backup-portainer-github-test/releases \
        -H "Authorization: token $GITHUB_TOKEN" \
        -H "Content-Type: application/json" \
        -d "$(jq -n \
              --arg tag "$LAST_TAG" \
              --arg name "$LAST_TAG" \
              --arg body "$CHANGELOG_BODY" \
              '{ tag_name: $tag, name: $name, body: $body, draft: false, prerelease: false }')"
  rules:
    - if: '$CI_COMMIT_TAG'
      when: manual

